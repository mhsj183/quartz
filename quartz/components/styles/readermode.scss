/* 右下角浮动目录按钮：有目录时常驻展示，点击切换侧边栏大纲显示/隐藏 */
#floating-toc-wrap {
  position: fixed;
  bottom: 2.25rem;
  right: 2.25rem;
  z-index: 30;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease, visibility 0.2s ease;

  &.visible {
    pointer-events: auto;
    opacity: 1;
    visibility: visible;
  }
}

.floating-toc-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2.75rem;
  height: 2.75rem;
  padding: 0;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  /* 纯色背景：不透明 */
  background: var(--light);
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  color: var(--tertiary);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;

  & svg {
    width: 1.35rem;
    height: 1.35rem;
    transition: fill 0.2s ease, stroke 0.2s ease;
    /* 默认（目录展开）：绿色高亮 */
    &.icon-open {
      fill: var(--tertiary);
      stroke: var(--tertiary);
    }
  }

  /* 目录收起时：灰色 */
  &.toc-collapsed svg {
    fill: var(--gray);
    stroke: var(--gray);
  }

  &:hover {
    background: var(--light);
    color: var(--tertiary);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    & svg {
      fill: var(--tertiary);
      stroke: var(--tertiary);
    }
  }
}

/* 小屏目录浮层打开时禁止背景滚动 */
body.toc-overlay-open {
  overflow: hidden;
}

/* 小屏目录右侧浮层（Notion 风格）：无蒙版，背板仅用于点击关闭 */
#toc-overlay-backdrop {
  position: fixed;
  inset: 0;
  z-index: 40;
  background: transparent;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.2s ease, visibility 0.2s ease;

  &.open {
    opacity: 1;
    visibility: visible;
    pointer-events: none;
  }
}

/* Notion 式：浮层不占满屏高，右下角与按钮对齐 */
#toc-overlay {
  position: fixed;
  top: auto;
  right: 2.25rem;
  bottom: 6rem;
  z-index: 41;
  width: auto;
  min-width: 120px;
  max-width: 90vw;
  max-height: calc(100vh - 8rem);
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  pointer-events: none;
  visibility: hidden;
  transform: translateY(20px);
  opacity: 0;
  transition: transform 0.25s ease-out, opacity 0.25s ease-out, visibility 0.25s ease-out;

  &.open {
    pointer-events: auto;
    visibility: visible;
    transform: translateY(0);
    opacity: 1;
  }
}

/* Notion 风格目录浮层：浅灰底、四角圆角卡片、高度随内容/视口（不占满屏） */
#toc-overlay .toc-overlay-panel {
  width: 100%;
  min-height: 0;
  max-height: calc(100vh - 8rem);
  overflow-y: auto;
  overflow-x: hidden;
  overscroll-behavior: contain;
  margin: 0;
  padding: 1.25rem 1.5rem 1.5rem;
  background: var(--light) !important;
  border-radius: 12px !important;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04) !important;
  -webkit-overflow-scrolling: touch;
  font-family: inherit;

  /* 浮层内克隆的目录：强制显示（避免继承 desktop-only 的 display:none） */
  .toc-overlay-clone,
  .desktop-only.toc-overlay-clone {
    display: flex !important;
    flex-direction: column;
    min-height: 0;
    margin-bottom: 0;

    &.toc-hidden {
      display: flex !important;
    }

    /* 隐藏大纲标题行 */
    .toc-header {
      display: none !important;
    }

    .toc-content,
    ul.toc-content.overflow {
      flex: 1;
      min-height: 0;
      max-height: none !important;
      padding: 0 !important;
      overflow-y: visible;
      overscroll-behavior: contain;
      margin: 0.25rem 0 0 !important;
      list-style: none;
      padding-left: 0;
    }

    /* Notion 风格目录项：紧凑行距、字体更小、无高亮 */
    ul.toc-content.overflow > li {
      margin-bottom: 0.1rem;
    }

    ul.toc-content.overflow > li:last-child {
      margin-bottom: 0;
    }

    ul.toc-content.overflow > li > a,
    ul.toc-content > li > a {
      display: block !important;
      line-height: 1.25 !important;
      padding: 0.1rem 0 !important;
      /* 未浏览项：浅色弱化 */
      color: var(--gray) !important;
      opacity: 0.75 !important;
      transition: color 0.2s ease, opacity 0.2s ease;
      background: transparent !important;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.95rem !important;

      &:hover {
        color: var(--dark) !important;
        opacity: 1 !important;
      }

      /* 已浏览项：深色接近默认正文色 */
      &.in-view {
        color: var(--dark) !important;
        opacity: 1 !important;
        font-weight: normal;
      }
    }
  }
}

/* 暗黑模式：提高按钮与目录浮层的边界对比，避免与页面底色融为一体 */
:root[saved-theme="dark"] {
  .floating-toc-btn {
    background: color-mix(in srgb, var(--light) 92%, white 8%) !important;
    border: 1px solid rgba(255, 255, 255, 0.14);
    box-shadow:
      0 6px 16px rgba(0, 0, 0, 0.36),
      0 0 0 1px rgba(255, 255, 255, 0.04) inset;
  }

  .floating-toc-btn:hover {
    background: color-mix(in srgb, var(--light) 89%, white 11%) !important;
    box-shadow:
      0 8px 20px rgba(0, 0, 0, 0.4),
      0 0 0 1px rgba(255, 255, 255, 0.05) inset;
  }

  #toc-overlay .toc-overlay-panel {
    background: color-mix(in srgb, var(--light) 94%, white 6%) !important;
    border: 1px solid rgba(255, 255, 255, 0.11);
    box-shadow:
      0 12px 28px rgba(0, 0, 0, 0.42),
      0 0 0 1px rgba(255, 255, 255, 0.035) inset !important;
  }

  #toc-overlay .toc-overlay-panel .toc-overlay-clone ul.toc-content.overflow > li > a,
  #toc-overlay .toc-overlay-panel .toc-overlay-clone ul.toc-content > li > a {
    color: color-mix(in srgb, var(--dark) 36%, var(--gray) 64%) !important;
    opacity: 0.9 !important;
  }
}
