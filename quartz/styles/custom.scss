@use "./base.scss";

// put your custom CSS here!

/* 左侧探索栏底部与页脚底对齐：非移动端让 .explorer 占满侧栏剩余高度 */
@media (min-width: 800px) {
  .page > #quartz-body .sidebar.left {
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden; /* 保证 flex 子项高度可计算 */
  }
  .page > #quartz-body .sidebar.left .explorer {
    flex: 1 1 0%;
    min-height: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .page > #quartz-body .sidebar.left .explorer .explorer-content {
    flex: 1 1 0%;
    min-height: 0;
    overflow-y: auto;
    /* 仅在有溢出时显示滚动条，overlay 时滚动条不占布局空间，避免默认占位 */
    overflow-y: overlay;
  }
}

/* 封面容器：暗黑模式按钮在右上方 */
.site-cover-wrapper {
  position: relative;
  margin: 0 0 clamp(0.5rem, 2vw, 1.25rem);
  /* 定义 CSS 变量供侧栏高度计算使用 */
  --cover-height: clamp(140px, 20vw, 200px);
  --cover-margin: clamp(0.5rem, 2vw, 1.25rem);

  @media (max-width: 800px) {
    --cover-height: clamp(120px, 34vw, 160px);
  }
}

.site-cover-wrapper .site-cover {
  width: 100%;
  height: var(--cover-height);
  background-size: cover;
  /* 裁剪聚焦：右侧开放书本 + 花瓶玫瑰 + 暖色墙面，弱化左侧条纹 */
  background-position: 74% 50%;
  background-repeat: no-repeat;

  @media (max-width: 800px) {
    background-position: 72% 54%;
  }
}

/* 左侧栏：搜索+暗黑模式一行与探索目录同宽，两组件垂直居中 */
.page > #quartz-body .sidebar.left .flex-component {
  width: 100%;
  min-width: 0;
  align-items: center;
}
.page > #quartz-body .sidebar.left .flex-component .search {
  max-width: none;
  min-width: 0;
}

/* 有封面图时，调整侧栏和页头，避免侧栏把页脚挤出可视区 */
.site-cover-wrapper + .page {
  #quartz-body {
    @media (min-width: 1200px) {
      /*
       * 桌面端兜底：将页面高度约束到首屏可视区域（扣除封面），
       * 并固定为 头部 + 主体(可伸缩) + 页脚 三行，避免侧栏内容把页脚挤出首屏。
       */
      min-height: calc(100vh - var(--cover-height) - var(--cover-margin));
      grid-template-rows: auto minmax(0, 1fr) auto;
    }

    .sidebar {
      padding-top: clamp(0.75rem, 2.5vw, 1.5rem);
      /* 使用 max-height 而非 fixed height，避免参与网格行高挤压 footer */
      height: auto;
      max-height: calc(100vh - var(--cover-height) - var(--cover-margin) - 2.5rem);
      min-height: 0;
      overflow: hidden;
    }

    .sidebar.right {
      overflow-y: auto;
    }

    .page-header {
      margin: clamp(0.75rem, 2.5vw, 1.5rem) 0 0 0;
    }
  }
}

@media (max-width: 800px) {
  .site-cover-wrapper + .page #quartz-body .sidebar {
    height: unset;
    max-height: none;
  }
}

@media (min-width: 800px) {
  /* 强制覆盖 base 的 100vh，避免侧栏把首页 footer 顶出首屏 */
  .page > #quartz-body .sidebar {
    height: auto !important;
    max-height: calc(100vh - var(--cover-height, 0px) - var(--cover-margin, 0px) - 2.5rem) !important;
    min-height: 0;
    overflow: hidden;
  }

  .page > #quartz-body .sidebar.left .explorer,
  .page > #quartz-body .sidebar.left .explorer .explorer-content,
  .page > #quartz-body .sidebar.right {
    min-height: 0;
    overflow-y: auto;
  }
}

@media (min-width: 800px) and (max-height: 860px) {
  .site-cover-wrapper {
    --cover-height: clamp(100px, 16vw, 130px);
  }
}

@media (min-width: 800px) {
  /* 首页内容较少但目录较长时，额外收紧侧栏高度，确保 footer 首屏可见 */
  body[data-slug="index"] .page > #quartz-body .sidebar {
    max-height: max(16rem, calc(100vh - var(--cover-height, 0px) - var(--cover-margin, 0px) - 10rem)) !important;
  }
}

/* 大纲隐藏时：缩小右侧栏、正文区域扩展以适应屏幕 */
@media (min-width: 1200px) {
  body.toc-panel-hidden .page > #quartz-body {
    grid-template-columns: 320px 1fr 160px;
  }
}

/* Notion 风格目录浮层（写在此处保证最后加载、覆盖 readermode/toc 样式） */
#toc-overlay {
  max-width: 90vw !important;
}

#toc-overlay .toc-overlay-panel {
  width: auto;
  min-width: 120px;
  min-height: 0;
  overflow-y: auto;
  overflow-x: hidden;
  overscroll-behavior: contain;
  margin: 0;
  padding: 1.5rem 1.5rem 2rem;
  background: var(--light) !important;
  border-radius: 16px !important;
  box-shadow: -2px 0 16px rgba(0, 0, 0, 0.06), -1px 0 4px rgba(0, 0, 0, 0.03) !important;
  -webkit-overflow-scrolling: touch;
  font-family: inherit;
  white-space: normal;
  word-wrap: break-word;

  .toc-overlay-clone,
  .desktop-only.toc-overlay-clone {
    .toc-header {
      flex-shrink: 0;
      margin-bottom: 0.75rem;
      color: var(--dark) !important;
      font-weight: 600;
    }

    .toc-content,
    ul.toc-content.overflow {
      flex: 1;
      width: 100%;
      min-height: 0;
      max-height: none !important;
      /* 文字区域上下留出安全边距，避免首尾条目贴近浮层边界 */
      padding: 0.45rem 0 !important;
      overflow-y: visible;
      margin: 0.25rem 0 0 !important;
      list-style: none;
      padding-left: 0;
    }

    /* 浮层目录不使用底部渐变遮罩，避免最后一项被压暗 */
    ul.toc-content.overflow.gradient-active {
      mask-image: none !important;
    }

    /* 隐藏 overflow 观察用占位项，避免底部出现多余空白 */
    ul.toc-content.overflow > li.overflow-end {
      display: none;
    }

    ul.toc-content.overflow > li {
      margin-bottom: 0.08rem;
    }
    ul.toc-content.overflow > li:last-child {
      margin-bottom: 0;
    }

    ul.toc-content.overflow > li > a,
    ul.toc-content > li > a {
      display: block !important;
      width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.4 !important;
      padding: 0.12rem 0.6rem !important;
      color: var(--gray) !important;
      opacity: 0.78 !important;
      transition: color 0.2s ease, opacity 0.2s ease, background-color 0.2s ease;
      background: transparent !important;
      text-decoration: none;
      border-radius: 4px;
      white-space: normal;
      word-wrap: break-word;

      &:hover {
        background-color: transparent !important;
        color: var(--tertiary) !important;
        opacity: 1 !important;
      }
      &.in-view {
        color: color-mix(in srgb, var(--gray) 70%, var(--dark)) !important;
        opacity: 1 !important;
        font-weight: 500;
      }
    }
  }
}

/* 暗黑模式下与 readermode 保持一致：低对比深色卡片，不突兀但有边界 */
:root[saved-theme="dark"] #toc-overlay .toc-overlay-panel {
  background: color-mix(in srgb, var(--light) 94%, white 6%) !important;
  border: 1px solid rgba(255, 255, 255, 0.11);
  box-shadow:
    0 12px 28px rgba(0, 0, 0, 0.42),
    0 0 0 1px rgba(255, 255, 255, 0.035) inset !important;
}

:root[saved-theme="dark"] #toc-overlay .toc-overlay-panel .toc-overlay-clone {
  ul.toc-content.overflow > li > a,
  ul.toc-content > li > a {
    color: color-mix(in srgb, var(--dark) 36%, var(--gray) 64%) !important;
    opacity: 0.9 !important;

    &:hover {
      color: color-mix(in srgb, var(--dark) 74%, var(--tertiary) 26%) !important;
      opacity: 1 !important;
    }

    &.in-view {
      color: color-mix(in srgb, var(--dark) 62%, var(--gray) 38%) !important;
      opacity: 1 !important;
      font-weight: 500;
    }
  }
}

